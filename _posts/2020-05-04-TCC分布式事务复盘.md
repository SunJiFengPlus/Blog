---
layout:     post
title:      TCC 分布式事务复盘 - 更新中
subtitle:   
date:       2020-05-04
author:     孙继峰
header-img: img/th2.jpg
catalog: true
tags:
    - TCC
    - 分布式事务
---

> 近期刚完成分布式事务相关的开发与对接, 想借此机会做一次复盘.

### 目标回顾
##### 我的目标
完成设计、保证其正常提供服务
 
##### 组长的目标 
跨服务之间数据一致性, 方便业务端调用, 并没有精确的把整个流程时间加在考量结果中, 
只是时间能够接受即可, 要求数据一致性

### 结果评估
数据一致, 除非服务节点故障, 需要人工重试

### 流程梳理
#### TCC分布式事务实现概览
![](https://github.com/SunJiFengPlus/SunJiFengPlus.github.io/blob/master/img/SequenceDiagram1.png)

#### 事务管理器实现
主要对外提供以下几个HTTP接口:
- register: 
- join:
- confirm:
- cancel:
- retryConfirmUnit:
- retryCancelUnit:

#### 库存适配事务管理器
参与分布式事务的服务实现三个接口:<br>
- try: 预留资源
- confirm: 提交资源
- cancel: 回滚资源

##### 更优方案
使用开源事务管理器, 当初不使用开源的事务管理器是因为不能够跨语言, 
但是现有开源的分布式事务已经支持HTTP协议了, 技术调研不足 (反思).

#### 过程中踩的坑
mvn -test 导致数据库事务死锁
@Async 导致循环引用
RedissonClient 与 RedisTemplate 不兼容